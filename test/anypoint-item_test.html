<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>anypoint-item test</title>

    <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../node_modules/wct-browser-legacy/browser.js"></script>

    <script type="module" src="../anypoint-item.js"></script>
    <script type="module" src="../anypoint-icon-item.js"></script>
  </head>
  <body>

    <test-fixture id="item">
      <template>
        <div role="listbox">
          <anypoint-item>item</anypoint-item>
        </div>
      </template>
    </test-fixture>

    <test-fixture id="button">
      <template>
        <div role="listbox">
          <button class="anypoint-item" role="option">item</button>
        </div>
      </template>
    </test-fixture>

    <test-fixture id="iconItem">
      <template>
        <div role="listbox">
          <anypoint-icon-item>item</anypoint-icon-item>
        </div>
      </template>
    </test-fixture>

    <test-fixture id="item-with-input">
      <template>
        <div role="list">
          <anypoint-item><input></anypoint-item>
        </div>
      </template>
    </test-fixture>

    <test-fixture id="iconItem-with-input">
      <template>
        <div role="list">
          <anypoint-icon-item><input></anypoint-icon-item>
        </div>
      </template>
    </test-fixture>

    <script type="module">
      import 'wct-browser-legacy/a11ySuite.js';
      import { Base } from '../node_modules/@polymer/polymer/polymer-legacy.js';

      function keyboardEventFor(type, keyCode, modifiers, key) {
        const event = new CustomEvent(type, {
          detail: 0,
          bubbles: true,
          cancelable: true,
          // Allow event to go outside a ShadowRoot.
          composed: true
        });

        event.keyCode = keyCode;
        event.code = keyCode;

        modifiers = modifiers || [];
        if (typeof modifiers === 'string') {
          modifiers = [modifiers];
        }
        event.shiftKey = modifiers.indexOf('shift') !== -1;
        event.altKey = modifiers.indexOf('alt') !== -1;
        event.ctrlKey = modifiers.indexOf('ctrl') !== -1;
        event.metaKey = modifiers.indexOf('meta') !== -1;

        event.key = key;

        return event;
      }

      function keyEventOn(target, type, keyCode, modifiers, key) {
        target.dispatchEvent(keyboardEventFor(type, keyCode, modifiers, key));
      }

      function keyDownOn(target, keyCode, modifiers, key) {
        keyEventOn(target, 'keydown', keyCode, modifiers, key);
      }

      function keyUpOn(target, keyCode, modifiers, key) {
        keyEventOn(target, 'keyup', keyCode, modifiers, key);
      }

      function pressAndReleaseKeyOn(target, keyCode, modifiers, key) {
        keyDownOn(target, keyCode, modifiers, key);
        Base.async(function() {
          keyUpOn(target, keyCode, modifiers, key);
        }, 1);
      }

      function pressSpace(target) {
        pressAndReleaseKeyOn(target, 32);
      }

      function pressEnter(target) {
        pressAndReleaseKeyOn(target, 13);
      }

      suite('anypoint-item basic', () => {

        let item, clickHandler;
        setup(function() {
          item = fixture('item').querySelector('anypoint-item');
          clickHandler = sinon.spy();
          item.addEventListener('click', clickHandler);
        });

        test('space triggers a click event', function(done) {
          pressSpace(item);
          Base.async(function(){
            // You need two ticks, one for the MockInteractions event, and one
            // for the button event.
            Base.async(function(){
              expect(clickHandler.callCount).to.be.equal(1);
              done();
            }, 1);
          }, 1);
        });

        test('enter triggers a click event', function(done) {
          pressEnter(item);
          Base.async(function(){
            // You need two ticks, one for the MockInteractions event, and one
            // for the button event.
            Base.async(function(){
              expect(clickHandler.callCount).to.be.equal(1);
              done();
            }, 1);
          }, 1);
        });
      });

      suite('anypoint-icon-item basic', function() {
        let item, clickHandler;
        setup(function() {
          item = fixture('iconItem').querySelector('anypoint-icon-item');
          clickHandler = sinon.spy();
          item.addEventListener('click', clickHandler);
        });

        test('space triggers a click event', function(done) {
          pressSpace(item);
          Base.async(function(){
            // You need two ticks, one for the MockInteractions event, and one
            // for the button event.
            Base.async(function(){
              expect(clickHandler.callCount).to.be.equal(1);
              done();
            }, 1);
          }, 1);
        });

        test('click triggers a click event', function(done) {
          item.click();
          Base.async(function(){
            expect(clickHandler.callCount).to.be.equal(1);
            done();
          }, 1);
        });
      });

      suite('clickable element inside item', function() {
        test('anypoint-item: space in child native input does not trigger a click event', function(done) {
          var f = fixture('item-with-input');
          var outerItem = f.querySelector('anypoint-item');
          var innerInput = f.querySelector('input');
          var itemClickHandler = sinon.spy();
          outerItem.addEventListener('click', itemClickHandler);
          innerInput.focus();
          pressSpace(innerInput);
          Base.async(function(){
            expect(itemClickHandler.callCount).to.be.equal(0);
            done();
          }, 1);
        });

        test('anypoint-icon-item: space in child input does not trigger a click event', function(done) {
          var f = fixture('iconItem-with-input');
          var outerItem = f.querySelector('anypoint-icon-item');
          var innerInput = f.querySelector('input');
          var itemClickHandler = sinon.spy();
          outerItem.addEventListener('click', itemClickHandler);
          pressSpace(innerInput);
          Base.async(function(){
            expect(itemClickHandler.callCount).to.be.equal(0);
            done();
          }, 1);
        });
      });

      suite('item a11y tests', function() {
        let item, iconItem;
        setup(function() {
          item = fixture('item').querySelector('anypoint-item');
          iconItem = fixture('iconItem').querySelector('anypoint-icon-item');
        });
        
        test('item has role="listitem"', function() {
          assert.equal(item.getAttribute('role'), 'option', 'has role="option"');
        });

        test('icon item has role="listitem"', function() {
          assert.equal(iconItem.getAttribute('role'), 'option', 'has role="option"');
        });

        a11ySuite('item');
        a11ySuite('button');
        a11ySuite('iconItem');
      });

    </script>

  </body>
</html>
